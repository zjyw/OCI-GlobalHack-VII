{"version":3,"sources":["public/src/client/register.js"],"names":["define","translator","zxcvbn","Register","validationError","successIcon","init","email","$","username","password","password_confirm","register","handleLanguageOverride","val","app","previousUrl","on","length","validateEmail","query","utils","params","token","decodeURIComponent","text","this","value","slugify","validateUsername","validatePassword","validatePasswordConfirm","validateForm","callback","e","registerBtn","errorEl","addClass","preventDefault","parents","ajaxSubmit","headers","x-csrf-token","config","csrf_token","success","data","removeClass","referrer","pathname","urlToLocation","url","registered","qs","param","window","location","href","message","translate","msg","bootbox","alert","ajaxify","go","error","responseText","defaultLang","translated","status","relative_path","find","email_notify","isEmailValid","showError","socket","emit","err","exists","alertError","showSuccess","username_notify","minimumUsernameLength","maximumUsernameLength","isUserNameValid","password_notify","password_confirm_notify","passwordStrength","minimumPasswordLength","isPasswordValid","score","minimumPasswordStrength","hasClass","element","html","parent","show","user","uid","userLang","formEl","langEl","append"],"mappings":"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","file":"public/src/client/register.js","sourcesContent":["'use strict';\n\n\ndefine('forum/register', ['translator', 'zxcvbn'], function (translator, zxcvbn) {\n\tvar Register = {};\n\tvar validationError = false;\n\tvar successIcon = '';\n\n\tRegister.init = function () {\n\t\tvar email = $('#email');\n\t\tvar username = $('#username');\n\t\tvar password = $('#password');\n\t\tvar password_confirm = $('#password-confirm');\n\t\tvar register = $('#register');\n\n\t\thandleLanguageOverride();\n\n\t\t$('#referrer').val(app.previousUrl);\n\t\t$('#content #noscript').val('false');\n\n\t\temail.on('blur', function () {\n\t\t\tif (email.val().length) {\n\t\t\t\tvalidateEmail(email.val());\n\t\t\t}\n\t\t});\n\n\t\tvar query = utils.params();\n\t\tif (query.email && query.token) {\n\t\t\temail.val(decodeURIComponent(query.email));\n\t\t\t$('#token').val(query.token);\n\t\t}\n\n\t\t// Update the \"others can mention you via\" text\n\t\tusername.on('keyup', function () {\n\t\t\t$('#yourUsername').text(this.value.length > 0 ? utils.slugify(this.value) : 'username');\n\t\t});\n\n\t\tusername.on('blur', function () {\n\t\t\tif (username.val().length) {\n\t\t\t\tvalidateUsername(username.val());\n\t\t\t}\n\t\t});\n\n\t\tpassword.on('blur', function () {\n\t\t\tif (password.val().length) {\n\t\t\t\tvalidatePassword(password.val(), password_confirm.val());\n\t\t\t}\n\t\t});\n\n\t\tpassword_confirm.on('blur', function () {\n\t\t\tif (password_confirm.val().length) {\n\t\t\t\tvalidatePasswordConfirm(password.val(), password_confirm.val());\n\t\t\t}\n\t\t});\n\n\t\tfunction validateForm(callback) {\n\t\t\tvalidationError = false;\n\t\t\tvalidatePassword(password.val(), password_confirm.val());\n\t\t\tvalidatePasswordConfirm(password.val(), password_confirm.val());\n\n\t\t\tvalidateEmail(email.val(), function () {\n\t\t\t\tvalidateUsername(username.val(), callback);\n\t\t\t});\n\t\t}\n\n\t\tregister.on('click', function (e) {\n\t\t\tvar registerBtn = $(this);\n\t\t\tvar errorEl = $('#register-error-notify');\n\t\t\terrorEl.addClass('hidden');\n\t\t\te.preventDefault();\n\t\t\tvalidateForm(function () {\n\t\t\t\tif (validationError) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tregisterBtn.addClass('disabled');\n\n\t\t\t\tregisterBtn.parents('form').ajaxSubmit({\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'x-csrf-token': config.csrf_token,\n\t\t\t\t\t},\n\t\t\t\t\tsuccess: function (data) {\n\t\t\t\t\t\tregisterBtn.removeClass('disabled');\n\t\t\t\t\t\tif (!data) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (data.referrer) {\n\t\t\t\t\t\t\tvar pathname = utils.urlToLocation(data.referrer).pathname;\n\n\t\t\t\t\t\t\tvar params = utils.params({ url: data.referrer });\n\t\t\t\t\t\t\tparams.registered = true;\n\t\t\t\t\t\t\tvar qs = decodeURIComponent($.param(params));\n\n\t\t\t\t\t\t\twindow.location.href = pathname + '?' + qs;\n\t\t\t\t\t\t} else if (data.message) {\n\t\t\t\t\t\t\ttranslator.translate(data.message, function (msg) {\n\t\t\t\t\t\t\t\tbootbox.alert(msg);\n\t\t\t\t\t\t\t\tajaxify.go('/');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\terror: function (data) {\n\t\t\t\t\t\ttranslator.translate(data.responseText, config.defaultLang, function (translated) {\n\t\t\t\t\t\t\tif (data.status === 403 && data.responseText === 'Forbidden') {\n\t\t\t\t\t\t\t\twindow.location.href = config.relative_path + '/register?error=csrf-invalid';\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\terrorEl.find('p').text(translated);\n\t\t\t\t\t\t\t\terrorEl.removeClass('hidden');\n\t\t\t\t\t\t\t\tregisterBtn.removeClass('disabled');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tfunction validateEmail(email, callback) {\n\t\tcallback = callback || function () {};\n\t\tvar email_notify = $('#email-notify');\n\n\t\tif (!utils.isEmailValid(email)) {\n\t\t\tshowError(email_notify, '[[error:invalid-email]]');\n\t\t\treturn callback();\n\t\t}\n\n\t\tsocket.emit('user.emailExists', {\n\t\t\temail: email,\n\t\t}, function (err, exists) {\n\t\t\tif (err) {\n\t\t\t\tapp.alertError(err.message);\n\t\t\t\treturn callback();\n\t\t\t}\n\n\t\t\tif (exists) {\n\t\t\t\tshowError(email_notify, '[[error:email-taken]]');\n\t\t\t} else {\n\t\t\t\tshowSuccess(email_notify, successIcon);\n\t\t\t}\n\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tfunction validateUsername(username, callback) {\n\t\tcallback = callback || function () {};\n\n\t\tvar username_notify = $('#username-notify');\n\n\t\tif (username.length < ajaxify.data.minimumUsernameLength) {\n\t\t\tshowError(username_notify, '[[error:username-too-short]]');\n\t\t} else if (username.length > ajaxify.data.maximumUsernameLength) {\n\t\t\tshowError(username_notify, '[[error:username-too-long]]');\n\t\t} else if (!utils.isUserNameValid(username) || !utils.slugify(username)) {\n\t\t\tshowError(username_notify, '[[error:invalid-username]]');\n\t\t} else {\n\t\t\tsocket.emit('user.exists', {\n\t\t\t\tusername: username,\n\t\t\t}, function (err, exists) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tif (exists) {\n\t\t\t\t\tshowError(username_notify, '[[error:username-taken]]');\n\t\t\t\t} else {\n\t\t\t\t\tshowSuccess(username_notify, successIcon);\n\t\t\t\t}\n\n\t\t\t\tcallback();\n\t\t\t});\n\t\t}\n\t}\n\n\tfunction validatePassword(password, password_confirm) {\n\t\tvar password_notify = $('#password-notify');\n\t\tvar password_confirm_notify = $('#password-confirm-notify');\n\t\tvar passwordStrength = zxcvbn(password);\n\n\t\tif (password.length < ajaxify.data.minimumPasswordLength) {\n\t\t\tshowError(password_notify, '[[reset_password:password_too_short]]');\n\t\t} else if (password.length > 512) {\n\t\t\tshowError(password_notify, '[[error:password-too-long]]');\n\t\t} else if (!utils.isPasswordValid(password)) {\n\t\t\tshowError(password_notify, '[[user:change_password_error]]');\n\t\t} else if (password === $('#username').val()) {\n\t\t\tshowError(password_notify, '[[user:password_same_as_username]]');\n\t\t} else if (password === $('#email').val()) {\n\t\t\tshowError(password_notify, '[[user:password_same_as_email]]');\n\t\t} else if (passwordStrength.score < ajaxify.data.minimumPasswordStrength) {\n\t\t\tshowError(password_notify, '[[user:weak_password]]');\n\t\t} else {\n\t\t\tshowSuccess(password_notify, successIcon);\n\t\t}\n\n\t\tif (password !== password_confirm && password_confirm !== '') {\n\t\t\tshowError(password_confirm_notify, '[[user:change_password_error_match]]');\n\t\t}\n\t}\n\n\tfunction validatePasswordConfirm(password, password_confirm) {\n\t\tvar password_notify = $('#password-notify');\n\t\tvar password_confirm_notify = $('#password-confirm-notify');\n\n\t\tif (!password || password_notify.hasClass('alert-error')) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (password !== password_confirm) {\n\t\t\tshowError(password_confirm_notify, '[[user:change_password_error_match]]');\n\t\t} else {\n\t\t\tshowSuccess(password_confirm_notify, successIcon);\n\t\t}\n\t}\n\n\tfunction showError(element, msg) {\n\t\ttranslator.translate(msg, function (msg) {\n\t\t\telement.html(msg);\n\t\t\telement.parent()\n\t\t\t\t.removeClass('register-success')\n\t\t\t\t.addClass('register-danger');\n\t\t\telement.show();\n\t\t});\n\t\tvalidationError = true;\n\t}\n\n\tfunction showSuccess(element, msg) {\n\t\ttranslator.translate(msg, function (msg) {\n\t\t\telement.html(msg);\n\t\t\telement.parent()\n\t\t\t\t.removeClass('register-danger')\n\t\t\t\t.addClass('register-success');\n\t\t\telement.show();\n\t\t});\n\t}\n\n\tfunction handleLanguageOverride() {\n\t\tif (!app.user.uid && config.defaultLang !== config.userLang) {\n\t\t\tvar formEl = $('[component=\"register/local\"]');\n\t\t\tvar langEl = $('<input type=\"hidden\" name=\"userLang\" value=\"' + config.userLang + '\" />');\n\n\t\t\tformEl.append(langEl);\n\t\t}\n\t}\n\n\treturn Register;\n});\n"]}