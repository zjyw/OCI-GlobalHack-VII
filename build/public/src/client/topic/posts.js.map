{"version":3,"sources":["public/src/client/topic/posts.js"],"names":["define","pagination","infinitescroll","postTools","images","navigator","components","Posts","onNewPost","data","posts","length","parseInt","tid","ajaxify","loggedIn","app","user","uid","privileges","timestamp","Date","now","timestampISO","utils","toISOString","modifyPostsByPrivileges","updatePostCounts","postcount","updatePostCount","config","usePagination","onNewPostPagination","onNewPostInfiniteScroll","require","replies","forEach","post","selfPost","display_edit_tools","isAdminOrMod","display_delete_tools","display_moderator_tools","display_move_tools","display_post_menu","locked","postSharing","deleted","i","cmp","get","html","attr","addCommasToNumbers","scrollToPost","scrollToPostIfSelf","loadImages","pageCount","Math","max","ceil","topic","postsPerPage","direction","topicPostSort","isPostVisible","currentPage","createNewPosts","not","scrollToMyPost","setTimeout","loadPage","updatePagination","$","relative_path","page","paginationData","parseAndTranslate","after","remove","isPreviousPostAdded","index","go","pid","addClass","scrollBottom","repliesSelector","callback","removeAlreadyAddedPosts","newPosts","allSamePids","each","el","this","removeClass","p","hasClass","filter","before","last","first","slug","window","trigger","insertAfter","height","document","scrollTop","insertBefore","append","removeExtra","processPage","loadMorePosts","scrollActive","_infiniteScrollTimeout","find","afterEl","isNumber","indicatorEl","is","fadeIn","loadMore","count","done","fadeOut","update","unloadImages","showBottomPostBar","createUserTooltips","replaceSelfLinks","makeNumbersHumanReadable","timeago","addBlockquoteEllipses","hidePostToolsForDeletedPosts","mainPost","placeHolder","clone","toggle","blockquotes","$this"],"mappings":"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","file":"public/src/client/topic/posts.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/posts', [\n\t'forum/pagination',\n\t'forum/infinitescroll',\n\t'forum/topic/postTools',\n\t'forum/topic/images',\n\t'navigator',\n\t'components',\n], function (pagination, infinitescroll, postTools, images, navigator, components) {\n\tvar Posts = { };\n\n\tPosts.onNewPost = function (data) {\n\t\tif (!data || !data.posts || !data.posts.length || parseInt(data.posts[0].tid, 10) !== parseInt(ajaxify.data.tid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata.loggedIn = !!app.user.uid;\n\t\tdata.privileges = ajaxify.data.privileges;\n\n\t\t// prevent timeago in future by setting timestamp to 1 sec behind now\n\t\tdata.posts[0].timestamp = Date.now() - 1000;\n\t\tdata.posts[0].timestampISO = utils.toISOString(data.posts[0].timestamp);\n\n\t\tPosts.modifyPostsByPrivileges(data.posts);\n\n\t\tupdatePostCounts(data.posts);\n\n\t\tajaxify.data.postcount += 1;\n\t\tpostTools.updatePostCount(ajaxify.data.postcount);\n\n\t\tif (config.usePagination) {\n\t\t\tonNewPostPagination(data);\n\t\t} else {\n\t\t\tonNewPostInfiniteScroll(data);\n\t\t}\n\n\t\trequire(['forum/topic/replies'], function (replies) {\n\t\t\treplies.onNewPost(data);\n\t\t});\n\t};\n\n\tPosts.modifyPostsByPrivileges = function (posts) {\n\t\tposts.forEach(function (post) {\n\t\t\tpost.selfPost = !!app.user.uid && parseInt(post.uid, 10) === parseInt(app.user.uid, 10);\n\t\t\tpost.display_edit_tools = (ajaxify.data.privileges['posts:edit'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_delete_tools = (ajaxify.data.privileges['posts:delete'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_moderator_tools = post.display_edit_tools || post.display_delete_tools;\n\t\t\tpost.display_move_tools = ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_post_menu = ajaxify.data.privileges.isAdminOrMod || (post.selfPost && !ajaxify.data.locked) || ((app.user.uid || ajaxify.data.postSharing.length) && !post.deleted);\n\t\t});\n\t};\n\n\tfunction updatePostCounts(posts) {\n\t\tfor (var i = 0; i < posts.length; i += 1) {\n\t\t\tvar cmp = components.get('user/postcount', posts[i].uid);\n\t\t\tcmp.html(parseInt(cmp.attr('data-postcount'), 10) + 1);\n\t\t\tutils.addCommasToNumbers(cmp);\n\t\t}\n\t}\n\n\tfunction onNewPostPagination(data) {\n\t\tfunction scrollToPost() {\n\t\t\tscrollToPostIfSelf(data.posts[0]);\n\t\t\timages.loadImages();\n\t\t}\n\n\t\tvar posts = data.posts;\n\n\t\tajaxify.data.pagination.pageCount = Math.max(1, Math.ceil(posts[0].topic.postcount / config.postsPerPage));\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\n\n\t\tvar isPostVisible = (ajaxify.data.pagination.currentPage === ajaxify.data.pagination.pageCount && direction === 1) ||\n\t\t\t\t\t\t\t(ajaxify.data.pagination.currentPage === 1 && direction === -1);\n\n\t\tif (isPostVisible) {\n\t\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, scrollToPost);\n\t\t} else if (ajaxify.data.scrollToMyPost && parseInt(posts[0].uid, 10) === parseInt(app.user.uid, 10)) {\n\t\t\t// https://github.com/NodeBB/NodeBB/issues/5004#issuecomment-247157441\n\t\t\tsetTimeout(function () {\n\t\t\t\tpagination.loadPage(ajaxify.data.pagination.pageCount, scrollToPost);\n\t\t\t}, 250);\n\t\t} else {\n\t\t\tupdatePagination();\n\t\t}\n\t}\n\n\tfunction updatePagination() {\n\t\t$.get(config.relative_path + '/api/topic/pagination/' + ajaxify.data.tid, { page: ajaxify.data.pagination.currentPage }, function (paginationData) {\n\t\t\tapp.parseAndTranslate('partials/paginator', { pagination: paginationData }, function (html) {\n\t\t\t\t$('[component=\"pagination\"]').after(html).remove();\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction onNewPostInfiniteScroll(data) {\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\n\n\t\tvar isPreviousPostAdded = $('[component=\"post\"][data-index=\"' + (data.posts[0].index - 1) + '\"]').length;\n\t\tif (!isPreviousPostAdded && (!data.posts[0].selfPost || !ajaxify.data.scrollToMyPost)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isPreviousPostAdded && data.posts[0].selfPost) {\n\t\t\treturn ajaxify.go('post/' + data.posts[0].pid);\n\t\t}\n\n\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, function (html) {\n\t\t\tif (html) {\n\t\t\t\thtml.addClass('new');\n\t\t\t}\n\t\t\tscrollToPostIfSelf(data.posts[0]);\n\t\t\timages.loadImages();\n\t\t});\n\t}\n\n\tfunction scrollToPostIfSelf(post) {\n\t\tif (post.selfPost && ajaxify.data.scrollToMyPost) {\n\t\t\tnavigator.scrollBottom(post.index);\n\t\t}\n\t}\n\n\tfunction createNewPosts(data, repliesSelector, direction, callback) {\n\t\tcallback = callback || function () {};\n\t\tif (!data || (data.posts && !data.posts.length)) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tfunction removeAlreadyAddedPosts() {\n\t\t\tvar newPosts = $('[component=\"post\"].new');\n\n\t\t\tif (newPosts.length === data.posts.length) {\n\t\t\t\tvar allSamePids = true;\n\t\t\t\tnewPosts.each(function (index, el) {\n\t\t\t\t\tif (parseInt($(el).attr('data-pid'), 10) !== parseInt(data.posts[index].pid, 10)) {\n\t\t\t\t\t\tallSamePids = false;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tif (allSamePids) {\n\t\t\t\t\tnewPosts.each(function () {\n\t\t\t\t\t\t$(this).removeClass('new');\n\t\t\t\t\t});\n\t\t\t\t\tdata.posts.length = 0;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (newPosts.length && data.posts.length > 1) {\n\t\t\t\tdata.posts.forEach(function (post) {\n\t\t\t\t\tvar p = components.get('post', 'pid', post.pid);\n\t\t\t\t\tif (p.hasClass('new')) {\n\t\t\t\t\t\tp.remove();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdata.posts = data.posts.filter(function (post) {\n\t\t\t\treturn $('[component=\"post\"][data-pid=\"' + post.pid + '\"]').length === 0;\n\t\t\t});\n\t\t}\n\n\t\tremoveAlreadyAddedPosts();\n\n\t\tif (!data.posts.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tvar after;\n\t\tvar before;\n\n\t\tif (direction > 0 && repliesSelector.length) {\n\t\t\tafter = repliesSelector.last();\n\t\t} else if (direction < 0 && repliesSelector.length) {\n\t\t\tbefore = repliesSelector.first();\n\t\t}\n\n\t\tdata.slug = ajaxify.data.slug;\n\n\t\t$(window).trigger('action:posts.loading', { posts: data.posts, after: after, before: before });\n\n\t\tapp.parseAndTranslate('topic', 'posts', data, function (html) {\n\t\t\thtml = html.filter(function () {\n\t\t\t\tvar pid = $(this).attr('data-pid');\n\t\t\t\treturn pid && $('[component=\"post\"][data-pid=\"' + pid + '\"]').length === 0;\n\t\t\t});\n\n\t\t\tif (after) {\n\t\t\t\thtml.insertAfter(after);\n\t\t\t} else if (before) {\n\t\t\t\t// Save document height and position for future reference (about 5 lines down)\n\t\t\t\tvar height = $(document).height();\n\t\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\t\thtml.insertBefore(before);\n\n\t\t\t\t// Now restore the relative position the user was on prior to new post insertion\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t\t} else {\n\t\t\t\tcomponents.get('topic').append(html);\n\t\t\t}\n\n\t\t\tinfinitescroll.removeExtra($('[component=\"post\"]'), direction, config.postsPerPage * 2);\n\n\t\t\t$(window).trigger('action:posts.loaded', { posts: data.posts });\n\n\t\t\tPosts.processPage(html);\n\n\t\t\tcallback(html);\n\t\t});\n\t}\n\n\tPosts.loadMorePosts = function (direction) {\n\t\tif (!components.get('topic').length || navigator.scrollActive || Posts._infiniteScrollTimeout) {\n\t\t\treturn;\n\t\t}\n\n\t\tPosts._infiniteScrollTimeout = setTimeout(function () {\n\t\t\tdelete Posts._infiniteScrollTimeout;\n\t\t}, 1000);\n\t\tvar replies = components.get('topic').find(components.get('post').not('[data-index=0]').not('.new'));\n\t\tvar afterEl = direction > 0 ? replies.last() : replies.first();\n\t\tvar after = parseInt(afterEl.attr('data-index'), 10) || 0;\n\n\t\tvar tid = ajaxify.data.tid;\n\t\tif (!utils.isNumber(tid) || !utils.isNumber(after) || (direction < 0 && components.get('post', 'index', 0).length)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar indicatorEl = $('.loading-indicator');\n\t\tif (!indicatorEl.is(':animated')) {\n\t\t\tindicatorEl.fadeIn();\n\t\t}\n\n\t\tinfinitescroll.loadMore('topics.loadMore', {\n\t\t\ttid: tid,\n\t\t\tafter: after,\n\t\t\tcount: config.postsPerPage,\n\t\t\tdirection: direction,\n\t\t\ttopicPostSort: config.topicPostSort,\n\t\t}, function (data, done) {\n\t\t\tindicatorEl.fadeOut();\n\n\t\t\tif (data && data.posts && data.posts.length) {\n\t\t\t\tcreateNewPosts(data, replies, direction, done);\n\t\t\t} else {\n\t\t\t\tnavigator.update();\n\t\t\t\tdone();\n\t\t\t}\n\t\t});\n\t};\n\n\tPosts.processPage = function (posts) {\n\t\timages.unloadImages(posts);\n\t\tPosts.showBottomPostBar();\n\t\tposts.find('[component=\"post/content\"] img:not(.not-responsive)').addClass('img-responsive');\n\t\tapp.createUserTooltips(posts);\n\t\tapp.replaceSelfLinks(posts.find('a'));\n\t\tutils.addCommasToNumbers(posts.find('.formatted-number'));\n\t\tutils.makeNumbersHumanReadable(posts.find('.human-readable-number'));\n\t\tposts.find('.timeago').timeago();\n\n\t\taddBlockquoteEllipses(posts.find('[component=\"post/content\"] > blockquote > blockquote'));\n\t\thidePostToolsForDeletedPosts(posts);\n\t};\n\n\tPosts.showBottomPostBar = function () {\n\t\tvar mainPost = components.get('post', 'index', 0);\n\t\tvar placeHolder = $('.post-bar-placeholder');\n\t\tvar posts = $('[component=\"post\"]');\n\t\tif (!!mainPost.length && posts.length > 1 && $('.post-bar').length < 2 && placeHolder.length) {\n\t\t\t$('.post-bar').clone().insertAfter(placeHolder);\n\t\t\tplaceHolder.remove();\n\t\t} else if (mainPost.length && posts.length < 2) {\n\t\t\tmainPost.find('.post-bar').remove();\n\t\t}\n\t};\n\n\tfunction hidePostToolsForDeletedPosts(posts) {\n\t\tposts.each(function () {\n\t\t\tif ($(this).hasClass('deleted')) {\n\t\t\t\tpostTools.toggle($(this).attr('data-pid'), true);\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction addBlockquoteEllipses(blockquotes) {\n\t\tblockquotes.each(function () {\n\t\t\tvar $this = $(this);\n\t\t\tif ($this.find(':hidden:not(br)').length && !$this.find('.toggle').length) {\n\t\t\t\t$this.append('<i class=\"fa fa-angle-down pointer toggle\"></i>');\n\t\t\t}\n\t\t});\n\t}\n\n\treturn Posts;\n});\n"]}