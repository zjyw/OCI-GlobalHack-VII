"use strict";define("forum/topic/posts",["forum/pagination","forum/infinitescroll","forum/topic/postTools","forum/topic/images","navigator","components"],function(t,o,e,a,i,s){var n={};n.onNewPost=function(t){if(!t||!t.posts||!t.posts.length||parseInt(t.posts[0].tid,10)!==parseInt(ajaxify.data.tid,10)){return}t.loggedIn=!!app.user.uid;t.privileges=ajaxify.data.privileges;t.posts[0].timestamp=Date.now()-1e3;t.posts[0].timestampISO=utils.toISOString(t.posts[0].timestamp);n.modifyPostsByPrivileges(t.posts);r(t.posts);ajaxify.data.postcount+=1;e.updatePostCount(ajaxify.data.postcount);if(config.usePagination){p(t)}else{l(t)}require(["forum/topic/replies"],function(o){o.onNewPost(t)})};n.modifyPostsByPrivileges=function(t){t.forEach(function(t){t.selfPost=!!app.user.uid&&parseInt(t.uid,10)===parseInt(app.user.uid,10);t.display_edit_tools=ajaxify.data.privileges["posts:edit"]&&t.selfPost||ajaxify.data.privileges.isAdminOrMod;t.display_delete_tools=ajaxify.data.privileges["posts:delete"]&&t.selfPost||ajaxify.data.privileges.isAdminOrMod;t.display_moderator_tools=t.display_edit_tools||t.display_delete_tools;t.display_move_tools=ajaxify.data.privileges.isAdminOrMod;t.display_post_menu=ajaxify.data.privileges.isAdminOrMod||t.selfPost&&!ajaxify.data.locked||(app.user.uid||ajaxify.data.postSharing.length)&&!t.deleted})};function r(t){for(var o=0;o<t.length;o+=1){var e=s.get("user/postcount",t[o].uid);e.html(parseInt(e.attr("data-postcount"),10)+1);utils.addCommasToNumbers(e)}}function p(o){function e(){f(o.posts[0]);a.loadImages()}var i=o.posts;ajaxify.data.pagination.pageCount=Math.max(1,Math.ceil(i[0].topic.postcount/config.postsPerPage));var n=config.topicPostSort==="oldest_to_newest"||config.topicPostSort==="most_votes"?1:-1;var r=ajaxify.data.pagination.currentPage===ajaxify.data.pagination.pageCount&&n===1||ajaxify.data.pagination.currentPage===1&&n===-1;if(r){c(o,s.get("post").not("[data-index=0]"),n,e)}else if(ajaxify.data.scrollToMyPost&&parseInt(i[0].uid,10)===parseInt(app.user.uid,10)){setTimeout(function(){t.loadPage(ajaxify.data.pagination.pageCount,e)},250)}else{d()}}function d(){$.get(config.relative_path+"/api/topic/pagination/"+ajaxify.data.tid,{page:ajaxify.data.pagination.currentPage},function(t){app.parseAndTranslate("partials/paginator",{pagination:t},function(t){$('[component="pagination"]').after(t).remove()})})}function l(t){var o=config.topicPostSort==="oldest_to_newest"||config.topicPostSort==="most_votes"?1:-1;var e=$('[component="post"][data-index="'+(t.posts[0].index-1)+'"]').length;if(!e&&(!t.posts[0].selfPost||!ajaxify.data.scrollToMyPost)){return}if(!e&&t.posts[0].selfPost){return ajaxify.go("post/"+t.posts[0].pid)}c(t,s.get("post").not("[data-index=0]"),o,function(o){if(o){o.addClass("new")}f(t.posts[0]);a.loadImages()})}function f(t){if(t.selfPost&&ajaxify.data.scrollToMyPost){i.scrollBottom(t.index)}}function c(t,e,a,i){i=i||function(){};if(!t||t.posts&&!t.posts.length){return i()}function r(){var o=$('[component="post"].new');if(o.length===t.posts.length){var e=true;o.each(function(o,a){if(parseInt($(a).attr("data-pid"),10)!==parseInt(t.posts[o].pid,10)){e=false}});if(e){o.each(function(){$(this).removeClass("new")});t.posts.length=0;return}}if(o.length&&t.posts.length>1){t.posts.forEach(function(t){var o=s.get("post","pid",t.pid);if(o.hasClass("new")){o.remove()}})}t.posts=t.posts.filter(function(t){return $('[component="post"][data-pid="'+t.pid+'"]').length===0})}r();if(!t.posts.length){return i()}var p;var d;if(a>0&&e.length){p=e.last()}else if(a<0&&e.length){d=e.first()}t.slug=ajaxify.data.slug;$(window).trigger("action:posts.loading",{posts:t.posts,after:p,before:d});app.parseAndTranslate("topic","posts",t,function(e){e=e.filter(function(){var t=$(this).attr("data-pid");return t&&$('[component="post"][data-pid="'+t+'"]').length===0});if(p){e.insertAfter(p)}else if(d){var r=$(document).height();var l=$(window).scrollTop();e.insertBefore(d);$(window).scrollTop(l+($(document).height()-r))}else{s.get("topic").append(e)}o.removeExtra($('[component="post"]'),a,config.postsPerPage*2);$(window).trigger("action:posts.loaded",{posts:t.posts});n.processPage(e);i(e)})}n.loadMorePosts=function(t){if(!s.get("topic").length||i.scrollActive||n._infiniteScrollTimeout){return}n._infiniteScrollTimeout=setTimeout(function(){delete n._infiniteScrollTimeout},1e3);var e=s.get("topic").find(s.get("post").not("[data-index=0]").not(".new"));var a=t>0?e.last():e.first();var r=parseInt(a.attr("data-index"),10)||0;var p=ajaxify.data.tid;if(!utils.isNumber(p)||!utils.isNumber(r)||t<0&&s.get("post","index",0).length){return}var d=$(".loading-indicator");if(!d.is(":animated")){d.fadeIn()}o.loadMore("topics.loadMore",{tid:p,after:r,count:config.postsPerPage,direction:t,topicPostSort:config.topicPostSort},function(o,a){d.fadeOut();if(o&&o.posts&&o.posts.length){c(o,e,t,a)}else{i.update();a()}})};n.processPage=function(t){a.unloadImages(t);n.showBottomPostBar();t.find('[component="post/content"] img:not(.not-responsive)').addClass("img-responsive");app.createUserTooltips(t);app.replaceSelfLinks(t.find("a"));utils.addCommasToNumbers(t.find(".formatted-number"));utils.makeNumbersHumanReadable(t.find(".human-readable-number"));t.find(".timeago").timeago();u(t.find('[component="post/content"] > blockquote > blockquote'));g(t)};n.showBottomPostBar=function(){var t=s.get("post","index",0);var o=$(".post-bar-placeholder");var e=$('[component="post"]');if(!!t.length&&e.length>1&&$(".post-bar").length<2&&o.length){$(".post-bar").clone().insertAfter(o);o.remove()}else if(t.length&&e.length<2){t.find(".post-bar").remove()}};function g(t){t.each(function(){if($(this).hasClass("deleted")){e.toggle($(this).attr("data-pid"),true)}})}function u(t){t.each(function(){var t=$(this);if(t.find(":hidden:not(br)").length&&!t.find(".toggle").length){t.append('<i class="fa fa-angle-down pointer toggle"></i>')}})}return n});
//# sourceMappingURL=public/src/client/topic/posts.js.map